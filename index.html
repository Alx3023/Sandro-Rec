<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Sandro Rec Radio - Professional Audio Suite</title>
  <style>
    :root {
      --primary-bg: #0a0a0f;
      --secondary-bg: #12121b;
      --tertiary-bg: #1a1a24;
      --panel-bg: #16161f;
      --surface-bg: #20202b;
      --accent-blue: #3b82f6;
      --accent-purple: #8b5cf6;
      --accent-cyan: #06b6d4;
      --accent-red: #ef4444;
      --accent-green: #10b981;
      --accent-yellow: #f59e0b;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #64748b;
      --border-dark: #2d2d3a;
      --border-light: #3e3e4d;
      --shadow-heavy: 0 10px 30px rgba(0, 0, 0, 0.7);
      --shadow-light: 0 5px 15px rgba(0, 0, 0, 0.5);
      --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.8);
      
      --glass-bg: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.36);
      
      --font-heading: 'Inter', sans-serif;
      --font-body: 'Inter', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --font-size-xs: 0.75rem;
      --font-size-sm: 0.875rem;
      --font-size-base: 1rem;
      --font-size-lg: 1.125rem;
      --font-size-xl: 1.25rem;
      --font-size-2xl: 1.5rem;
      --font-size-3xl: 1.875rem;
      --font-weight-normal: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 600;
      --font-weight-bold: 700;
      --font-weight-extrabold: 800;
      --line-height-tight: 1.2;
      --line-height-normal: 1.5;
      --letter-spacing-tight: -0.025em;
      --letter-spacing-wide: 0.025em;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-body);
      background: var(--primary-bg);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .app-container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .main-header {
      background: linear-gradient(135deg, 
        rgba(18, 18, 27, 0.9), 
        rgba(26, 26, 36, 0.9)
      );
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px 30px;
      margin-bottom: 30px;
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      position: relative;
      overflow: hidden;
      animation: fadeInUp 0.6s ease-out;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      z-index: 2;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      box-shadow: 
        0 0 30px rgba(59, 130, 246, 0.4),
        inset 0 0 30px rgba(255, 255, 255, 0.1);
    }

    .logo::before {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, 
        transparent 30%, 
        rgba(255, 255, 255, 0.3) 50%, 
        transparent 70%
      );
      animation: shine 3s infinite linear;
    }

    @keyframes shine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .logo i {
      font-size: 28px;
      color: white;
      z-index: 1;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
    }

    .app-name {
      font-size: var(--font-size-3xl);
      font-weight: var(--font-weight-extrabold);
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: var(--letter-spacing-tight);
      line-height: var(--line-height-tight);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .app-tagline {
      font-size: var(--font-size-xs);
      color: var(--text-muted);
      font-weight: var(--font-weight-medium);
      letter-spacing: 1.5px;
      text-transform: uppercase;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .live-indicator-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: var(--font-size-sm);
      color: var(--accent-green);
      font-weight: var(--font-weight-semibold);
      background: rgba(16, 185, 129, 0.1);
      padding: 8px 16px;
      border-radius: 12px;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .live-dot {
      width: 8px;
      height: 8px;
      background: var(--accent-green);
      border-radius: 50%;
      animation: livePulse 1s ease-in-out infinite;
    }

    @keyframes livePulse {
      0%, 100% { 
        transform: scale(1); 
        opacity: 1;
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
      }
      50% { 
        transform: scale(1.5); 
        opacity: 0.7;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0);
      }
    }

    .rec-status {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 20px;
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }

    .rec-dot {
      width: 10px;
      height: 10px;
      background: var(--accent-red);
      border-radius: 50%;
      animation: pulse 1.5s infinite;
      box-shadow: 0 0 15px var(--accent-red);
    }

    @keyframes pulse {
      0%, 100% { 
        opacity: 1; 
        transform: scale(1); 
        box-shadow: 0 0 15px var(--accent-red);
      }
      50% { 
        opacity: 0.7; 
        transform: scale(1.2); 
        box-shadow: 0 0 25px var(--accent-red);
      }
    }

    /* Main Layout */
    .main-content {
      display: grid;
      grid-template-columns: 280px 1fr 320px;
      gap: 20px;
    }

    /* Panels */
    .glass-panel {
      background: linear-gradient(135deg, 
        rgba(22, 22, 31, 0.9), 
        rgba(18, 18, 27, 0.9)
      );
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 25px;
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      animation: panelSlideIn 0.6s ease-out;
    }

    @keyframes panelSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Panel Sections */
    .panel-section {
      margin-bottom: 30px;
      animation: fadeInUp 0.4s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .section-title {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: var(--letter-spacing-wide);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-dark);
    }

    .section-title i {
      color: var(--accent-blue);
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-field {
      width: 100%;
      padding: 14px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-dark);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: var(--font-size-sm);
      margin-bottom: 15px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .input-field:focus {
      outline: none;
      border-color: var(--accent-blue);
      background: rgba(255, 255, 255, 0.08);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1),
                  0 0 20px rgba(59, 130, 246, 0.2);
    }

    /* Buttons with Shadow Effect (replaced 3D) */
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, 
        transparent 30%, 
        rgba(255, 255, 255, 0.1) 50%, 
        transparent 70%
      );
      transform: translateX(-100%);
      transition: transform 0.6s ease;
    }

    .btn:hover::after {
      transform: translateX(100%);
    }

    .btn-primary {
      background: linear-gradient(145deg, var(--accent-blue), #2563eb);
      color: white;
      box-shadow: 
        0 4px 15px rgba(59, 130, 246, 0.3),
        0 1px 3px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 
        0 8px 25px rgba(59, 130, 246, 0.4),
        0 2px 5px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    .btn-primary:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 
        0 2px 8px rgba(59, 130, 246, 0.3),
        0 1px 2px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .btn-danger {
      background: linear-gradient(145deg, var(--accent-red), #dc2626);
      color: white;
      box-shadow: 
        0 4px 15px rgba(239, 68, 68, 0.3),
        0 1px 3px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .btn-danger:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 
        0 8px 25px rgba(239, 68, 68, 0.4),
        0 2px 5px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    .btn-danger:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 
        0 2px 8px rgba(239, 68, 68, 0.3),
        0 1px 2px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .btn-success {
      background: linear-gradient(145deg, var(--accent-green), #059669);
      color: white;
      box-shadow: 
        0 4px 15px rgba(16, 185, 129, 0.3),
        0 1px 3px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .btn-success:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 
        0 8px 25px rgba(16, 185, 129, 0.4),
        0 2px 5px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    .btn-success:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 
        0 2px 8px rgba(16, 185, 129, 0.3),
        0 1px 2px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .btn-secondary {
      background: linear-gradient(145deg, #2d2d3a, #24242e);
      color: var(--text-secondary);
      box-shadow: 
        0 4px 15px rgba(0, 0, 0, 0.2),
        0 1px 3px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    .btn-secondary:hover:not(:disabled) {
      background: linear-gradient(145deg, #3a3a4a, #2d2d3a);
      transform: translateY(-2px);
      box-shadow: 
        0 8px 25px rgba(0, 0, 0, 0.3),
        0 2px 5px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.08);
    }

    .btn-secondary:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 
        0 2px 8px rgba(0, 0, 0, 0.2),
        0 1px 2px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: 
        0 2px 5px rgba(0, 0, 0, 0.1) !important;
    }

    .btn-loading {
      position: relative;
      color: transparent !important;
      cursor: wait !important;
    }

    .btn-loading::before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border: 2px solid white;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .button-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 20px;
    }

    /* Saved Stations List */
    .stations-list {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 15px;
      padding: 10px;
      border: 1px solid var(--border-dark);
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 400px;
      overflow-y: auto;
    }

    .stations-list::-webkit-scrollbar {
      width: 0;
      background: transparent;
    }

    .stations-list {
      scrollbar-width: none;
    }

    .station-item {
      padding: 15px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 10px;
      border: 1px solid var(--border-dark);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      flex-shrink: 0;
    }

    .station-item:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--accent-blue);
      transform: translateX(5px) translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .station-item.active {
      background: rgba(59, 130, 246, 0.1);
      border-color: var(--accent-blue);
      border-left: 4px solid var(--accent-blue);
    }

    .station-info {
      margin-bottom: 8px;
    }

    .station-name {
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
      margin-bottom: 5px;
      font-size: var(--font-size-sm);
    }

    .station-url {
      font-size: var(--font-size-xs);
      color: var(--text-muted);
      font-family: var(--font-mono);
      word-break: break-all;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .station-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .icon-btn {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      border: none;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    /* Waveform Display con VU Meter */
    .waveform-display {
      background: linear-gradient(135deg, 
        rgba(0, 0, 0, 0.3), 
        rgba(10, 10, 15, 0.5)
      );
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 25px;
      border: 1px solid var(--border-dark);
      backdrop-filter: blur(5px);
      position: relative;
      overflow: hidden;
      height: 300px;
    }

    .waveform-display.fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      height: 100vh;
      width: 100vw;
      z-index: 1000;
      border-radius: 0;
      margin: 0;
      padding: 20px;
    }

    .waveform-display::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        45deg,
        transparent 0%,
        rgba(59, 130, 246, 0.05) 50%,
        transparent 100%
      );
      animation: ambientGlow 8s ease-in-out infinite;
      z-index: 0;
    }

    @keyframes ambientGlow {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.6; }
    }

    /* Waveform Header - MODIFICATO */
    .waveform-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      position: relative;
      z-index: 2;
      gap: 15px;
      flex-wrap: nowrap;
    }

    .waveform-title {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }

    .waveform-title::before {
      content: '';
      width: 8px;
      height: 8px;
      background: var(--accent-cyan);
      border-radius: 50%;
      animation: audioPulse 1.2s ease-in-out infinite;
    }

    @keyframes audioPulse {
      0%, 100% { 
        transform: scale(1); 
        box-shadow: 0 0 0 0 rgba(6, 182, 212, 0.7);
      }
      50% { 
        transform: scale(1.3); 
        box-shadow: 0 0 0 4px rgba(6, 182, 212, 0);
      }
    }

    .waveform-time {
      font-family: var(--font-mono);
      color: var(--accent-cyan);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      background: rgba(6, 182, 212, 0.1);
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid rgba(6, 182, 212, 0.2);
      min-width: 80px;
      text-align: center;
      flex-shrink: 0;
    }

    /* Mode Selector Button - MODIFICATO */
    .mode-selector {
      flex-shrink: 0;
    }

    .mode-btn {
      padding: 8px 15px;
      font-size: var(--font-size-xs);
      background: rgba(59, 130, 246, 0.2);
      color: var(--accent-cyan);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: var(--font-weight-semibold);
      text-transform: uppercase;
      letter-spacing: 1px;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
    }

    .mode-btn:hover {
      background: rgba(59, 130, 246, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
    }

    .waveform-container {
      width: 100%;
      height: calc(100% - 40px);
      background: rgba(8, 8, 16, 0.8);
      border-radius: 10px;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(59, 130, 246, 0.2);
      box-shadow: 
        inset 0 0 20px rgba(0, 0, 0, 0.3),
        0 0 30px rgba(59, 130, 246, 0.1);
    }

    .waveform-canvas {
      width: 100%;
      height: 100%;
    }

    /* VU Meter Styles */
    .vu-meter-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: grid;
      grid-template-columns: repeat(40, 1fr);
      grid-template-rows: repeat(20, 1fr);
      gap: 2px;
      padding: 10px;
      z-index: 1;
      pointer-events: none;
    }

    .vu-meter-cell {
      background: rgba(59, 130, 246, 0.05);
      border-radius: 2px;
      transition: all 0.1s ease;
      position: relative;
      overflow: hidden;
    }

    .vu-meter-cell.active {
      background: linear-gradient(180deg, 
        rgba(59, 130, 246, 0.8),
        rgba(139, 92, 246, 0.9)
      );
      box-shadow: 
        0 0 10px rgba(59, 130, 246, 0.5),
        inset 0 0 10px rgba(255, 255, 255, 0.2);
    }

    .vu-meter-cell.peak {
      background: linear-gradient(180deg, 
        rgba(239, 68, 68, 0.9),
        rgba(245, 158, 11, 0.8)
      );
      box-shadow: 
        0 0 15px rgba(239, 68, 68, 0.7),
        inset 0 0 10px rgba(255, 255, 255, 0.3);
    }

    /* VU Meter Animations */
    .vu-meter-mode-pulse .vu-meter-cell.active {
      animation: vuCellPulse 0.3s ease-out infinite;
    }

    .vu-meter-mode-pulse .vu-meter-cell.peak {
      animation: vuCellFlash 0.5s ease-out infinite;
    }

    .vu-meter-mode-wave .vu-meter-cell.active {
      animation: waveEffect 2s infinite linear;
    }

    .vu-meter-mode-ripple .vu-meter-cell.active {
      animation: rippleEffect 1.5s infinite ease-in-out;
    }

    .vu-meter-mode-bounce .vu-meter-cell.active {
      animation: bounceEffect 0.8s infinite ease-in-out;
    }

    @keyframes vuCellPulse {
      0% { transform: scale(1); opacity: 0.7; }
      50% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); opacity: 0.7; }
    }

    @keyframes vuCellFlash {
      0% { transform: scale(1); opacity: 0.5; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 0.5; }
    }

    @keyframes waveEffect {
      0% { transform: scaleY(0.3); }
      50% { transform: scaleY(1); }
      100% { transform: scaleY(0.3); }
    }

    @keyframes rippleEffect {
      0% { transform: scale(0.8); opacity: 0.3; }
      50% { transform: scale(1.2); opacity: 0.8; }
      100% { transform: scale(0.8); opacity: 0.3; }
    }

    @keyframes bounceEffect {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }

    /* Volume Control */
    .volume-control-container {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 25px;
      border: 1px solid var(--border-dark);
      backdrop-filter: blur(5px);
    }

    .volume-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .volume-title {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .volume-value {
      font-family: var(--font-mono);
      color: var(--accent-cyan);
      font-weight: var(--font-weight-bold);
      background: rgba(6, 182, 212, 0.1);
      padding: 4px 12px;
      border-radius: 8px;
      min-width: 60px;
      text-align: center;
    }

    .volume-slider-container {
      position: relative;
      height: 40px;
      margin-bottom: 15px;
    }

    .volume-slider-track {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      transform: translateY(-50%);
      overflow: hidden;
    }

    .volume-slider-fill {
      height: 100%;
      background: linear-gradient(90deg, 
        var(--accent-green), 
        var(--accent-cyan)
      );
      border-radius: 4px;
      width: 80%;
      position: relative;
    }

    .volume-slider-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.2), 
        transparent
      );
      animation: shimmer 2s infinite linear;
    }

    .volume-slider-input {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      opacity: 0;
      cursor: pointer;
      z-index: 2;
    }

    .volume-control-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .volume-btn {
      padding: 12px;
      font-size: var(--font-size-sm);
    }

    .volume-btn-lg {
      grid-column: span 1;
    }

    .btn-plus-minus {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: var(--font-weight-bold);
    }

    /* Player Controls */
    .player-section {
      margin-top: 25px;
    }

    .player-controls {
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    .audio-player {
      width: 100%;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.2);
      filter: invert(1) hue-rotate(180deg) contrast(0.9) brightness(1.2);
    }

    /* Fix per il player audio - rimuove effetti 3D indesiderati */
    .audio-player::-webkit-media-controls-panel {
      background: transparent !important;
      border-radius: 10px !important;
    }

    .audio-player::-webkit-media-controls-enclosure {
      background: transparent !important;
      border-radius: 10px !important;
    }

    .time-display-container {
      display: flex;
      justify-content: space-between;
      font-family: var(--font-mono);
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
    }

    /* Audio Progress Bar */
    .audio-progress {
      margin: 15px 0;
    }

    .progress-bar {
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      position: relative;
      cursor: pointer;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, 
        var(--accent-blue), 
        var(--accent-cyan)
      );
      border-radius: 3px;
      width: 0%;
      transition: width 0.1s linear;
      position: relative;
      z-index: 1;
    }

    .progress-thumb {
      width: 16px;
      height: 16px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
      opacity: 0;
      transition: opacity 0.3s, transform 0.2s;
      z-index: 2;
      cursor: grab;
    }

    .progress-thumb:active {
      cursor: grabbing;
      transform: translate(-50%, -50%) scale(1.2);
    }

    .progress-bar:hover .progress-thumb {
      opacity: 1;
    }

    .control-buttons-large {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }

    .btn-large {
      padding: 18px;
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-bold);
    }

    /* Trim Controls */
    .trim-controls {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 25px;
      border: 1px solid var(--border-dark);
      backdrop-filter: blur(5px);
    }

    .trim-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .time-input {
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-dark);
      border-radius: 10px;
      color: var(--text-primary);
      font-family: var(--font-mono);
      text-align: center;
      font-size: var(--font-size-sm);
      transition: all 0.3s;
    }

    .time-input:focus {
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .trim-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .btn-medium {
      padding: 14px;
    }

    /* Export Section */
    .export-section {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid var(--border-dark);
      margin-bottom: 25px;
      backdrop-filter: blur(5px);
    }

    .export-options {
      margin: 20px 0;
    }

    .option-group {
      margin-bottom: 15px;
    }

    .option-label {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: block;
    }

    /* Format Select - CORRETTO */
    .format-select {
      width: 100%;
      max-width: 100%;
      padding: 12px 40px 12px 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-dark);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: var(--font-size-sm);
      cursor: pointer;
      transition: all 0.3s;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23cbd5e1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
      box-sizing: border-box;
    }

    .format-select:focus {
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
      outline: none;
    }

    .format-select option {
      background: var(--panel-bg);
      color: var(--text-primary);
      padding: 10px;
      font-size: var(--font-size-sm);
      max-width: 100%;
    }

    /* Clips Library */
    .clips-library {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid var(--border-dark);
      max-height: 300px;
      overflow-y: auto;
      backdrop-filter: blur(5px);
    }

    .clips-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 15px;
    }

    .clip-item {
      background: rgba(255, 255, 255, 0.02);
      border-radius: 10px;
      padding: 15px;
      border-left: 4px solid var(--accent-blue);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .clip-item:hover {
      background: rgba(255, 255, 255, 0.05);
      transform: translateX(5px) translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .clip-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .clip-title {
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
      font-size: var(--font-size-sm);
    }

    .clip-time {
      font-size: var(--font-size-xs);
      color: var(--text-muted);
      font-family: var(--font-mono);
    }

    .clip-meta {
      display: flex;
      gap: 15px;
      font-size: var(--font-size-xs);
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .clip-actions {
      display: flex;
      gap: 8px;
    }

    .btn-small {
      padding: 8px 12px;
      font-size: var(--font-size-xs);
    }

    /* Footer */
    .main-footer {
      margin-top: 30px;
      padding: 20px;
      background: linear-gradient(135deg, 
        rgba(18, 18, 27, 0.9), 
        rgba(26, 26, 36, 0.9)
      );
      border-radius: 20px;
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      backdrop-filter: blur(10px);
      animation: fadeInUp 0.8s ease-out;
    }

    .footer-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .status-info {
      display: flex;
      gap: 20px;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: var(--font-size-xs);
      color: var(--text-muted);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-green);
      box-shadow: 0 0 10px var(--accent-green);
    }

    .status-dot.recording {
      background: var(--accent-red);
      animation: pulse 1.5s infinite;
    }

    /* Utility Classes */
    .hidden {
      display: none !important;
    }

    .text-center {
      text-align: center;
    }

    .text-muted {
      color: var(--text-muted);
    }

    .mb-2 {
      margin-bottom: 10px;
    }

    .mt-2 {
      margin-top: 10px;
    }

    /* Tooltip */
    [data-tooltip] {
      position: relative;
    }

    [data-tooltip]::before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      padding: 6px 12px;
      background: var(--tertiary-bg);
      color: var(--text-primary);
      font-size: var(--font-size-xs);
      border-radius: 6px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      border: 1px solid var(--border-dark);
      box-shadow: var(--shadow-heavy);
      pointer-events: none;
    }

    [data-tooltip]:hover::before {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(-5px);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(5px);
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: linear-gradient(135deg, 
        rgba(22, 22, 31, 0.95), 
        rgba(18, 18, 27, 0.95)
      );
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 30px;
      width: 90%;
      max-width: 500px;
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      transform: translateY(-20px) scale(0.95);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-overlay.active .modal {
      transform: translateY(0) scale(1);
    }

    .modal-title {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
      margin-bottom: 20px;
    }

    .modal-input {
      width: 100%;
      padding: 14px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-dark);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: var(--font-size-sm);
      margin-bottom: 20px;
      transition: all 0.3s;
    }

    .modal-input:focus {
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .modal-buttons {
      display: flex;
      gap: 15px;
      justify-content: flex-end;
    }

    /* Animations */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .slide-in {
      animation: slideIn 0.3s ease-out;
    }

    /* Responsive */
    @media (max-width: 1400px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      
      .control-buttons-large {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .volume-control-buttons {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 768px) {
      .app-container {
        padding: 10px;
      }
      
      .main-header {
        padding: 15px;
      }
      
      .header-content {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .header-controls {
        flex-direction: column;
        gap: 10px;
      }
      
      /* Waveform Header mobile */
      .waveform-header {
        flex-wrap: wrap;
        gap: 10px;
      }
      
      .waveform-title {
        width: 100%;
        justify-content: center;
        margin-bottom: 5px;
      }
      
      .mode-selector {
        width: calc(50% - 5px);
      }
      
      .waveform-time {
        width: calc(50% - 5px);
      }
      
      .waveform-display {
        height: 200px;
      }
      
      .vu-meter-overlay {
        grid-template-columns: repeat(20, 1fr);
        grid-template-rows: repeat(15, 1fr);
        gap: 1px;
      }
      
      .control-buttons-large {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .btn-large {
        padding: 15px;
        font-size: var(--font-size-sm);
      }
      
      .button-grid,
      .trim-inputs,
      .trim-buttons {
        grid-template-columns: 1fr;
      }
      
      /* Previeni overflow nel select */
      .format-select {
        max-width: 100%;
        width: 100%;
      }
      
      .station-item,
      .clip-item {
        padding: 12px;
      }
      
      .modal {
        width: 95%;
        margin: 10px;
        padding: 20px;
      }
      
      .modal-buttons {
        flex-direction: column;
      }
      
      .footer-content {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .status-info {
        flex-direction: column;
        gap: 10px;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="main-header">
      <div class="header-content">
        <div class="logo-container">
          <div class="logo">
            <i class="fas fa-satellite-dish"></i>
          </div>
          <div class="brand-text">
            <h1 class="app-name">SANDRO REC RADIO</h1>
            <p class="app-tagline">Professional Audio Recording Suite</p>
          </div>
        </div>
        <div class="header-controls">
          <div class="live-indicator-header" id="liveIndicatorHeader">
            <div class="live-dot"></div>
            <span>LIVE</span>
          </div>
          <div class="rec-status hidden" id="recStatus">
            <div class="rec-dot"></div>
            <span>RECORDING</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Left Panel - Radio Stations -->
      <div class="left-panel glass-panel">
        <div class="panel-section">
          <div class="section-title">
            <i class="fas fa-broadcast-tower"></i>
            RADIO STATIONS
          </div>
          
          <div class="input-group">
            <input type="text" id="streamUrl" class="input-field" 
                   placeholder="https://stream.example.com/radio.mp3"
                   data-tooltip="Inserisci l'URL del stream radio">
            <input type="text" id="radioName" class="input-field" 
                   placeholder="Station Name (optional)"
                   data-tooltip="Nome della stazione (opzionale)">
            <div class="button-grid">
              <button id="loadStream" class="btn btn-primary" data-tooltip="Carica e riproduci lo stream">
                <i class="fas fa-play"></i> LOAD
              </button>
              <button id="saveStation" class="btn btn-secondary" data-tooltip="Salva la stazione nei preferiti">
                <i class="fas fa-save"></i> SAVE
              </button>
            </div>
          </div>
        </div>

        <div class="panel-section">
          <div class="section-title">
            <i class="fas fa-star"></i>
            SAVED STATIONS
            <span class="text-muted" id="stationsCount">(0)</span>
          </div>
          <div class="stations-list" id="stationsList">
            <!-- Stations will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Center Panel - Main Controls -->
      <div class="center-panel glass-panel">
        <!-- Waveform Display con VU Meter -->
        <div class="waveform-display" id="waveformDisplay">
          <div class="waveform-header">
            <div class="waveform-title">AUDIO WAVEFORM</div>
            <div class="mode-selector">
              <button class="mode-btn" id="modeBtn" data-tooltip="Click per cambiare modalità VU Meter">
                <i class="fas fa-wave-square"></i> PULSE MODE
              </button>
            </div>
            <div class="waveform-time" id="waveformTime">00:00</div>
          </div>
          
          <div class="waveform-container">
            <canvas id="waveformCanvas" class="waveform-canvas"></canvas>
            
            <!-- VU Meter Overlay -->
            <div class="vu-meter-overlay" id="vuMeterOverlay">
              <!-- VU Meter cells will be generated here -->
            </div>
          </div>
        </div>

        <!-- Volume Control riorganizzato -->
        <div class="volume-control-container">
          <div class="volume-header">
            <div class="volume-title">
              <i class="fas fa-volume-up"></i> VOLUME CONTROL
            </div>
            <div class="volume-value" id="volumeValue">80%</div>
          </div>
          <div class="volume-slider-container">
            <div class="volume-slider-track">
              <div class="volume-slider-fill" id="volumeSliderFill"></div>
            </div>
            <input type="range" id="volumeSlider" class="volume-slider-input" 
                   min="0" max="100" value="80" data-tooltip="Regola il volume">
          </div>
          <div class="volume-control-buttons">
            <button id="volumeDecrease" class="btn btn-secondary btn-plus-minus" data-tooltip="Diminuisci volume (-)">
              <i class="fas fa-minus"></i>
            </button>
            <button id="volumeMute" class="btn btn-secondary volume-btn" data-tooltip="Silenzia">
              <i class="fas fa-volume-mute"></i> MUTE
            </button>
            <button id="volumeIncrease" class="btn btn-secondary btn-plus-minus" data-tooltip="Aumenta volume (+)">
              <i class="fas fa-plus"></i>
            </button>
            <button id="volumeReset" class="btn btn-secondary volume-btn-lg" style="grid-column: span 3;" data-tooltip="Ripristina volume al 80%">
              <i class="fas fa-redo"></i> RESET
            </button>
          </div>
        </div>

        <div class="player-section">
          <div class="player-controls">
            <audio id="audioPlayer" controls class="audio-player"></audio>
            
            <div class="time-display-container">
              <span id="currentTime">00:00</span>
              <span id="totalTime">00:00</span>
            </div>

            <!-- Progress Bar FIXED -->
            <div class="audio-progress">
              <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
                <div class="progress-thumb" id="progressThumb"></div>
              </div>
            </div>

            <div class="control-buttons-large">
              <button id="startRecording" class="btn btn-danger btn-large" disabled
                      data-tooltip="Ctrl+R - Inizia registrazione">
                <i class="fas fa-circle"></i> START REC
              </button>
              <button id="stopRecording" class="btn btn-secondary btn-large" disabled
                      data-tooltip="Ctrl+S - Ferma registrazione">
                <i class="fas fa-stop"></i> STOP
              </button>
              <button id="playSelection" class="btn btn-primary btn-large" disabled
                      data-tooltip="Spazio - Riproduci/Pausa">
                <i class="fas fa-play"></i> PLAY
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Panel - Editing -->
      <div class="right-panel glass-panel">
        <div class="panel-section">
          <div class="section-title">
            <i class="fas fa-cut"></i>
            TRIM AUDIO
          </div>
          
          <div class="trim-controls">
            <div class="trim-inputs">
              <input type="text" id="startTime" class="time-input" value="00:00:00" 
                     placeholder="Start" data-tooltip="Tempo di inizio selezione">
              <input type="text" id="endTime" class="time-input" value="00:00:00" 
                     placeholder="End" data-tooltip="Tempo di fine selezione">
            </div>
            
            <div class="trim-buttons">
              <button id="setStart" class="btn btn-secondary btn-medium"
                      data-tooltip="Imposta inizio al tempo corrente">
                <i class="fas fa-flag"></i> SET START
              </button>
              <button id="setEnd" class="btn btn-secondary btn-medium"
                      data-tooltip="Imposta fine al tempo corrente">
                <i class="fas fa-flag-checkered"></i> SET END
              </button>
            </div>
            
            <div class="mb-2 text-center text-muted" id="selectionDuration">
              Duration: 00:00:00
            </div>
            
            <button id="trimAudio" class="btn btn-primary" style="width: 100%;" disabled
                    data-tooltip="Ritaglia la selezione audio">
              <i class="fas fa-cut"></i> TRIM SELECTION
            </button>
          </div>
        </div>

        <div class="panel-section">
          <div class="section-title">
            <i class="fas fa-file-export"></i>
            EXPORT CLIP
          </div>
          
          <div class="export-section">
            <div class="option-group">
              <label class="option-label">FILE NAME</label>
              <input type="text" id="exportName" class="input-field" value="clip_001"
                     data-tooltip="Nome del file esportato">
            </div>
            
            <div class="option-group">
              <label class="option-label">FORMAT</label>
              <select id="exportFormat" class="format-select" data-tooltip="Formato di esportazione">
                <option value="wav">WAV (Lossless)</option>
                <option value="mp3">MP3 (Good Quality)</option>
                <option value="webm">WEBM (Web Optimized)</option>
              </select>
            </div>
            
            <button id="exportClip" class="btn btn-success" style="width: 100%; margin-top: 20px;" disabled
                    data-tooltip="Esporta il clip audio">
              <i class="fas fa-download"></i> EXPORT CLIP
            </button>
          </div>
        </div>

        <div class="panel-section">
          <div class="section-title">
            <i class="fas fa-folder"></i>
            CLIPS LIBRARY
            <span class="text-muted" id="clipsCount">(0)</span>
          </div>
          
          <div class="clips-library">
            <div class="clips-list" id="clipsList">
              <!-- Clips will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="main-footer">
      <div class="footer-content">
        <div class="status-info">
          <div class="status-item">
            <div class="status-dot" id="audioStatus"></div>
            <span>AUDIO: <span id="audioStatusTextFooter">READY</span></span>
          </div>
          <div class="status-item">
            <i class="fas fa-hdd"></i>
            <span>STORAGE: 65% FREE</span>
          </div>
          <div class="status-item">
            <i class="fas fa-keyboard"></i>
            <span>SHORTCUTS: Ctrl+R/S, Space, +/-</span>
          </div>
        </div>
        <div class="text-muted">
          v2.3 • Professional Audio Recording Suite • Glass UI Edition
        </div>
      </div>
    </footer>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="nameModal">
    <div class="modal">
      <h3 class="modal-title">Save Audio Clip</h3>
      <input type="text" id="clipNameInput" class="modal-input" placeholder="Enter clip name...">
      <div class="modal-buttons">
        <button id="cancelSave" class="btn btn-secondary">CANCEL</button>
        <button id="confirmSave" class="btn btn-primary">SAVE</button>
      </div>
    </div>
  </div>

  <script>
    class AudioRecorder {
      constructor() {
        // DOM Elements
        this.elements = {
          audioPlayer: document.getElementById('audioPlayer'),
          startRecording: document.getElementById('startRecording'),
          stopRecording: document.getElementById('stopRecording'),
          playSelection: document.getElementById('playSelection'),
          streamUrl: document.getElementById('streamUrl'),
          radioName: document.getElementById('radioName'),
          loadStream: document.getElementById('loadStream'),
          saveStation: document.getElementById('saveStation'),
          stationsList: document.getElementById('stationsList'),
          stationsCount: document.getElementById('stationsCount'),
          waveformCanvas: document.getElementById('waveformCanvas'),
          waveformTime: document.getElementById('waveformTime'),
          waveformDisplay: document.getElementById('waveformDisplay'),
          vuMeterOverlay: document.getElementById('vuMeterOverlay'),
          modeBtn: document.getElementById('modeBtn'),
          currentTime: document.getElementById('currentTime'),
          totalTime: document.getElementById('totalTime'),
          liveIndicatorHeader: document.getElementById('liveIndicatorHeader'),
          progressBar: document.getElementById('progressBar'),
          progressFill: document.getElementById('progressFill'),
          progressThumb: document.getElementById('progressThumb'),
          volumeSlider: document.getElementById('volumeSlider'),
          volumeSliderFill: document.getElementById('volumeSliderFill'),
          volumeValue: document.getElementById('volumeValue'),
          volumeMute: document.getElementById('volumeMute'),
          volumeReset: document.getElementById('volumeReset'),
          volumeIncrease: document.getElementById('volumeIncrease'),
          volumeDecrease: document.getElementById('volumeDecrease'),
          recStatus: document.getElementById('recStatus'),
          startTime: document.getElementById('startTime'),
          endTime: document.getElementById('endTime'),
          selectionDuration: document.getElementById('selectionDuration'),
          setStart: document.getElementById('setStart'),
          setEnd: document.getElementById('setEnd'),
          trimAudio: document.getElementById('trimAudio'),
          exportName: document.getElementById('exportName'),
          exportFormat: document.getElementById('exportFormat'),
          exportClip: document.getElementById('exportClip'),
          clipsList: document.getElementById('clipsList'),
          clipsCount: document.getElementById('clipsCount'),
          audioStatus: document.getElementById('audioStatus'),
          audioStatusTextFooter: document.getElementById('audioStatusTextFooter'),
          nameModal: document.getElementById('nameModal'),
          clipNameInput: document.getElementById('clipNameInput'),
          cancelSave: document.getElementById('cancelSave'),
          confirmSave: document.getElementById('confirmSave')
        };

        // Audio Context
        this.audioContext = null;
        this.mediaRecorder = null;
        this.audioBuffer = null;
        this.analyser = null;
        this.source = null;
        this.meterAnalyser = null;
        this.meterDataArray = null;
        
        // State Management
        this.isRecording = false;
        this.isPlaying = false;
        this.recordedChunks = [];
        this.recordingStartTime = 0;
        this.recordingTimer = null;
        this.waveformAnimation = null;
        this.vuMeterAnimation = null;
        this.isDraggingProgress = false;
        this.audioDataArray = null;
        this.bufferLength = 0;
        this.isMuted = false;
        this.lastVolume = 80;
        
        // Data Storage
        this.savedStations = JSON.parse(localStorage.getItem('savedStations')) || [];
        this.savedClips = JSON.parse(localStorage.getItem('savedClips')) || [];
        
        // Waveform
        this.waveformCtx = null;
        this.canvasWidth = 0;
        this.canvasHeight = 0;
        
        // VU Meter
        this.vuMeterCells = [];
        this.vuHistory = [];
        this.vuHistorySize = 20;
        this.vuMeterModes = ['pulse', 'wave', 'ripple', 'bounce'];
        this.currentVUModeIndex = 0;
        this.isFullscreen = false;
        
        // Initialize
        this.init();
      }

      init() {
        this.setupEventListeners();
        this.initVUMeter();
        this.loadSavedData();
        this.setupWaveform();
        this.setupProgressBar();
        this.setupVolumeControl();
        this.updateUI();
        this.setupKeyboardShortcuts();
        this.hideLiveIndicator();
        this.updateWaveformTime(0);
        this.updateModeButton();
      }

      setupEventListeners() {
        // Load Stream
        this.elements.loadStream.addEventListener('click', () => this.loadAudioStream());
        
        // Save Station
        this.elements.saveStation.addEventListener('click', () => this.saveStation());
        
        // Recording Controls
        this.elements.startRecording.addEventListener('click', () => this.startRecording());
        this.elements.stopRecording.addEventListener('click', () => this.stopRecording());
        this.elements.playSelection.addEventListener('click', () => this.playSelection());
        
        // Audio Player Events
        this.elements.audioPlayer.addEventListener('timeupdate', () => this.updatePlayerTime());
        this.elements.audioPlayer.addEventListener('loadedmetadata', () => this.onAudioLoaded());
        this.elements.audioPlayer.addEventListener('play', () => this.onAudioPlay());
        this.elements.audioPlayer.addEventListener('pause', () => this.onAudioPause());
        this.elements.audioPlayer.addEventListener('volumechange', () => this.updateVolumeDisplay());
        this.elements.audioPlayer.addEventListener('error', (e) => {
          console.error('Audio player error:', e);
          this.showMessage('Error playing audio stream', 'error');
        });
        
        // Progress Bar Events
        this.elements.progressBar.addEventListener('click', (e) => this.seekAudio(e));
        this.elements.progressThumb.addEventListener('mousedown', () => this.startDragProgress());
        document.addEventListener('mousemove', (e) => this.dragProgress(e));
        document.addEventListener('mouseup', () => this.stopDragProgress());
        
        // Volume Controls
        this.elements.volumeSlider.addEventListener('input', (e) => this.setVolume(e.target.value));
        this.elements.volumeMute.addEventListener('click', () => this.toggleMute());
        this.elements.volumeReset.addEventListener('click', () => this.resetVolume());
        this.elements.volumeIncrease.addEventListener('click', () => this.increaseVolume());
        this.elements.volumeDecrease.addEventListener('click', () => this.decreaseVolume());
        
        // Editing Controls
        this.elements.setStart.addEventListener('click', () => this.setSelectionPoint('start'));
        this.elements.setEnd.addEventListener('click', () => this.setSelectionPoint('end'));
        this.elements.trimAudio.addEventListener('click', () => this.trimAudio());
        
        // Export Clip
        this.elements.exportClip.addEventListener('click', () => this.exportClip());
        
        // VU Meter Mode Button
        this.elements.modeBtn.addEventListener('click', () => this.nextVUMode());
        
        // Fullscreen
        this.elements.waveformDisplay.addEventListener('dblclick', () => this.toggleFullscreen());
        
        // Modal
        this.elements.cancelSave.addEventListener('click', () => this.hideModal());
        this.elements.confirmSave.addEventListener('click', () => this.saveCurrentClip());
        
        // Initialize default stations
        if (this.savedStations.length === 0) {
          this.savedStations = [
            { 
              name: "Radio Italia FM", 
              url: "https://icecast.unitedradio.it/RadioItalia" 
            },
            { 
              name: "Radio DeeJay", 
              url: "https://stream10.xdevel.com/audio/0s5j5z8z8h8tv/stream/icecast.audio" 
            },
            { 
              name: "Rai Radio 1", 
              url: "http://icestreaming.rai.it/1.mp3" 
            }
          ];
          this.saveStations();
        }
      }

      setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
          // Space: play/pause
          if (e.code === 'Space' && !e.target.matches('input, textarea, select')) {
            e.preventDefault();
            if (this.elements.audioPlayer.paused) {
              this.elements.audioPlayer.play();
            } else {
              this.elements.audioPlayer.pause();
            }
          }
          
          // Ctrl+R: start recording
          if (e.ctrlKey && e.code === 'KeyR') {
            e.preventDefault();
            if (!this.elements.startRecording.disabled && !this.isRecording) {
              this.startRecording();
            }
          }
          
          // Ctrl+S: stop recording
          if (e.ctrlKey && e.code === 'KeyS') {
            e.preventDefault();
            if (this.isRecording) {
              this.stopRecording();
            }
          }
          
          // +: increase volume
          if (e.code === 'Equal' || e.code === 'NumpadAdd') {
            e.preventDefault();
            this.increaseVolume();
          }
          
          // -: decrease volume
          if (e.code === 'Minus' || e.code === 'NumpadSubtract') {
            e.preventDefault();
            this.decreaseVolume();
          }
          
          // F: toggle fullscreen
          if (e.code === 'KeyF') {
            e.preventDefault();
            this.toggleFullscreen();
          }
          
          // M: toggle VU meter mode
          if (e.code === 'KeyM') {
            e.preventDefault();
            this.nextVUMode();
          }
        });
      }

      loadSavedData() {
        this.updateStationsList();
        this.updateClipsList();
      }

      setupWaveform() {
        const canvas = this.elements.waveformCanvas;
        this.canvasWidth = canvas.offsetWidth;
        this.canvasHeight = canvas.offsetHeight;
        canvas.width = this.canvasWidth;
        canvas.height = this.canvasHeight;
        this.waveformCtx = canvas.getContext('2d');
        
        this.drawWaveform();
      }

      initVUMeter() {
        // Create VU meter grid (40x20 cells)
        this.elements.vuMeterOverlay.innerHTML = '';
        this.vuMeterCells = [];
        
        const rows = 20;
        const cols = 40;
        
        for (let row = 0; row < rows; row++) {
          for (let col = 0; col < cols; col++) {
            const cell = document.createElement('div');
            cell.className = 'vu-meter-cell';
            cell.style.gridColumn = `${col + 1}`;
            cell.style.gridRow = `${row + 1}`;
            this.elements.vuMeterOverlay.appendChild(cell);
            this.vuMeterCells.push({
              element: cell,
              row: row,
              col: col,
              active: false,
              intensity: 0
            });
          }
        }
        
        // Initialize history
        this.vuHistory = Array(this.vuHistorySize).fill(0);
        
        // Set initial mode
        this.updateVUMode();
      }

      nextVUMode() {
        this.currentVUModeIndex = (this.currentVUModeIndex + 1) % this.vuMeterModes.length;
        this.updateVUMode();
        this.updateModeButton();
        this.showMessage(`VU Meter Mode: ${this.vuMeterModes[this.currentVUModeIndex].toUpperCase()}`, 'info');
      }

      updateVUMode() {
        const mode = this.vuMeterModes[this.currentVUModeIndex];
        
        // Remove all mode classes
        this.elements.vuMeterOverlay.classList.remove('vu-meter-mode-pulse', 'vu-meter-mode-wave', 'vu-meter-mode-ripple', 'vu-meter-mode-bounce');
        
        // Add current mode class
        this.elements.vuMeterOverlay.classList.add(`vu-meter-mode-${mode}`);
      }

      updateModeButton() {
        const mode = this.vuMeterModes[this.currentVUModeIndex];
        const icon = this.elements.modeBtn.querySelector('i');
        const text = this.elements.modeBtn.querySelector('span');
        
        // Update icon based on mode
        switch(mode) {
          case 'pulse':
            icon.className = 'fas fa-wave-square';
            text.textContent = ' PULSE MODE';
            break;
          case 'wave':
            icon.className = 'fas fa-water';
            text.textContent = ' WAVE MODE';
            break;
          case 'ripple':
            icon.className = 'fas fa-circle-notch';
            text.textContent = ' RIPPLE MODE';
            break;
          case 'bounce':
            icon.className = 'fas fa-bounce';
            text.textContent = ' BOUNCE MODE';
            break;
        }
        
        // Update tooltip
        this.elements.modeBtn.setAttribute('data-tooltip', `Click per cambiare modalità VU Meter (Attuale: ${mode.toUpperCase()})`);
      }

      toggleFullscreen() {
        this.isFullscreen = !this.isFullscreen;
        
        if (this.isFullscreen) {
          this.elements.waveformDisplay.classList.add('fullscreen');
          document.body.style.overflow = 'hidden';
          this.showMessage('Fullscreen mode activated - Press F or double-click to exit', 'info');
        } else {
          this.elements.waveformDisplay.classList.remove('fullscreen');
          document.body.style.overflow = '';
          this.showMessage('Exited fullscreen mode', 'info');
        }
      }

      updateVUMeter(level) {
        // Convert linear level (0-1) to dB
        const db = 20 * Math.log10(level + 0.0001);
        const normalized = Math.max(0, Math.min(1, (db + 30) / 36)); // -30dB to +6dB
        
        // Update history
        this.vuHistory.shift();
        this.vuHistory.push(normalized);
        
        // Calculate average level for smoothing
        const avgLevel = this.vuHistory.reduce((a, b) => a + b, 0) / this.vuHistorySize;
        
        // Update each cell based on position
        this.vuMeterCells.forEach(cell => {
          // Calculate distance from center
          const centerX = 20;
          const centerY = 10;
          const distance = Math.sqrt(Math.pow(cell.col - centerX, 2) + Math.pow(cell.row - centerY, 2));
          const maxDistance = Math.sqrt(Math.pow(20, 2) + Math.pow(10, 2));
          
          // Calculate cell intensity based on level and position
          let cellIntensity = 0;
          
          // Create expanding wave effect
          const waveRadius = normalized * maxDistance * 1.5;
          const waveDistance = Math.abs(distance - waveRadius);
          
          if (waveDistance < 5) {
            // Wave front - high intensity
            cellIntensity = 0.8 + Math.random() * 0.2;
          } else if (distance < waveRadius) {
            // Inside wave - medium intensity
            const fade = 1 - (distance / waveRadius);
            cellIntensity = 0.3 + fade * 0.5;
          } else {
            // Outside wave - low intensity
            cellIntensity = Math.max(0.05, 0.2 * normalized);
          }
          
          // Add some randomness for organic feel
          cellIntensity += (Math.random() - 0.5) * 0.1;
          cellIntensity = Math.max(0, Math.min(1, cellIntensity));
          
          // Update cell
          cell.intensity = cellIntensity;
          
          if (cellIntensity > 0.7) {
            cell.element.classList.add('peak');
            cell.element.classList.remove('active');
          } else if (cellIntensity > 0.3) {
            cell.element.classList.add('active');
            cell.element.classList.remove('peak');
            cell.element.style.opacity = cellIntensity.toString();
          } else {
            cell.element.className = 'vu-meter-cell';
            cell.element.style.opacity = Math.max(0.05, cellIntensity).toString();
          }
        });
      }

      startVUMeter() {
        if (this.vuMeterAnimation) {
          cancelAnimationFrame(this.vuMeterAnimation);
        }
        
        const animate = () => {
          if (this.meterAnalyser && this.meterDataArray) {
            this.meterAnalyser.getByteFrequencyData(this.meterDataArray);
            
            // Calculate RMS level
            let sum = 0;
            for (let i = 0; i < this.meterDataArray.length; i++) {
              sum += (this.meterDataArray[i] - 128) ** 2;
            }
            const rms = Math.sqrt(sum / this.meterDataArray.length) / 128;
            
            this.updateVUMeter(rms);
          } else if (this.isPlaying) {
            // Simulate VU meter when no real audio data
            const time = Date.now() / 1000;
            const level = 0.3 + Math.sin(time * 2) * 0.3;
            this.updateVUMeter(level);
          }
          
          this.vuMeterAnimation = requestAnimationFrame(animate);
        };
        
        this.vuMeterAnimation = requestAnimationFrame(animate);
      }

      stopVUMeter() {
        if (this.vuMeterAnimation) {
          cancelAnimationFrame(this.vuMeterAnimation);
          this.vuMeterAnimation = null;
        }
        
        // Fade out VU meter
        this.vuMeterCells.forEach(cell => {
          cell.element.className = 'vu-meter-cell';
          cell.element.style.opacity = '0.05';
        });
      }

      showLiveIndicator() {
        this.elements.liveIndicatorHeader.style.display = 'flex';
      }

      hideLiveIndicator() {
        this.elements.liveIndicatorHeader.style.display = 'none';
      }

      setupVolumeControl() {
        // Initialize volume display
        this.updateVolumeDisplay();
        
        // Set initial volume
        this.setVolume(80);
      }

      setVolume(value) {
        const volume = parseInt(value);
        this.elements.audioPlayer.volume = volume / 100;
        this.elements.volumeSlider.value = volume;
        this.elements.volumeSliderFill.style.width = `${volume}%`;
        this.elements.volumeValue.textContent = `${volume}%`;
        
        // Save last volume for mute/unmute
        if (volume > 0) {
          this.lastVolume = volume;
        }
        
        this.updateMuteButton();
      }

      increaseVolume() {
        let currentVolume = parseInt(this.elements.volumeSlider.value);
        const newVolume = Math.min(100, currentVolume + 10);
        this.setVolume(newVolume);
      }

      decreaseVolume() {
        let currentVolume = parseInt(this.elements.volumeSlider.value);
        const newVolume = Math.max(0, currentVolume - 10);
        this.setVolume(newVolume);
      }

      toggleMute() {
        this.isMuted = !this.isMuted;
        
        if (this.isMuted) {
          this.elements.audioPlayer.volume = 0;
          this.elements.volumeSliderFill.style.width = '0%';
          this.elements.volumeValue.textContent = 'MUTED';
        } else {
          this.elements.audioPlayer.volume = this.lastVolume / 100;
          this.elements.volumeSlider.value = this.lastVolume;
          this.elements.volumeSliderFill.style.width = `${this.lastVolume}%`;
          this.elements.volumeValue.textContent = `${this.lastVolume}%`;
        }
        
        this.updateMuteButton();
      }

      resetVolume() {
        this.isMuted = false;
        this.setVolume(80);
      }

      updateMuteButton() {
        const icon = this.elements.volumeMute.querySelector('i');
        const text = this.elements.volumeMute.querySelector('span');
        
        if (this.isMuted || this.elements.audioPlayer.volume === 0) {
          icon.className = 'fas fa-volume-up';
          text.textContent = ' UNMUTE';
        } else {
          icon.className = 'fas fa-volume-mute';
          text.textContent = ' MUTE';
        }
      }

      updateVolumeDisplay() {
        const volume = Math.round(this.elements.audioPlayer.volume * 100);
        this.elements.volumeSlider.value = volume;
        this.elements.volumeSliderFill.style.width = `${volume}%`;
        this.elements.volumeValue.textContent = `${volume}%`;
        
        if (volume === 0 && !this.isMuted) {
          this.isMuted = true;
        } else if (volume > 0 && this.isMuted) {
          this.isMuted = false;
        }
        
        this.updateMuteButton();
      }

      drawWaveform() {
        if (!this.waveformCtx) return;
        
        const ctx = this.waveformCtx;
        const width = this.canvasWidth;
        const height = this.canvasHeight;
        
        // Clear with fade effect
        ctx.fillStyle = 'rgba(8, 8, 16, 0.3)';
        ctx.fillRect(0, 0, width, height);
        
        // Draw subtle grid
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.03)';
        ctx.lineWidth = 0.5;
        
        for (let i = 0; i < height; i += 20) {
          ctx.beginPath();
          ctx.moveTo(0, i);
          ctx.lineTo(width, i);
          ctx.stroke();
        }
        
        for (let i = 0; i < width; i += 40) {
          ctx.beginPath();
          ctx.moveTo(i, 0);
          ctx.lineTo(i, height);
          ctx.stroke();
        }
      }

      setupProgressBar() {
        this.updateProgressBar();
      }

      updateProgressBar() {
        const current = this.elements.audioPlayer.currentTime;
        const duration = this.elements.audioPlayer.duration || 1;
        const percentage = (current / duration) * 100;
        
        this.elements.progressFill.style.width = `${percentage}%`;
        this.elements.progressThumb.style.left = `${percentage}%`;
      }

      seekAudio(e) {
        if (this.isDraggingProgress) return;
        
        const rect = this.elements.progressBar.getBoundingClientRect();
        const percentage = (e.clientX - rect.left) / rect.width;
        const duration = this.elements.audioPlayer.duration || 0;
        this.elements.audioPlayer.currentTime = percentage * duration;
      }

      startDragProgress() {
        this.isDraggingProgress = true;
        this.elements.progressThumb.style.transform = 'translate(-50%, -50%) scale(1.2)';
      }

      dragProgress(e) {
        if (!this.isDraggingProgress) return;
        
        const rect = this.elements.progressBar.getBoundingClientRect();
        let percentage = (e.clientX - rect.left) / rect.width;
        percentage = Math.max(0, Math.min(1, percentage));
        
        const duration = this.elements.audioPlayer.duration || 0;
        this.elements.audioPlayer.currentTime = percentage * duration;
        
        this.elements.progressFill.style.width = `${percentage * 100}%`;
        this.elements.progressThumb.style.left = `${percentage * 100}%`;
      }

      stopDragProgress() {
        if (this.isDraggingProgress) {
          this.isDraggingProgress = false;
          this.elements.progressThumb.style.transform = 'translate(-50%, -50%)';
        }
      }

      updateUI() {
        const hasAudio = !!this.elements.audioPlayer.src && this.elements.audioPlayer.src !== '';
        
        this.elements.startRecording.disabled = !hasAudio || this.isRecording;
        this.elements.stopRecording.disabled = !this.isRecording;
        this.elements.playSelection.disabled = !this.audioBuffer;
        this.elements.trimAudio.disabled = !this.audioBuffer;
        this.elements.exportClip.disabled = !this.audioBuffer;
        
        if (hasAudio && this.elements.audioPlayer.readyState >= 2) {
          this.elements.audioStatus.style.background = '#10b981';
          this.elements.audioStatusTextFooter.textContent = 'CONNECTED';
        } else {
          this.elements.audioStatus.style.background = '#64748b';
          this.elements.audioStatusTextFooter.textContent = 'DISCONNECTED';
        }
      }

      updateWaveformTime(seconds) {
        this.elements.waveformTime.textContent = this.formatTime(seconds, false, true);
      }

      async loadAudioStream() {
        const url = this.elements.streamUrl.value.trim();
        if (!url) {
          this.showMessage('Please enter a stream URL', 'error');
          return;
        }

        try {
          this.elements.audioStatus.style.background = '#f59e0b';
          this.elements.audioStatusTextFooter.textContent = 'CONNECTING...';
          this.elements.loadStream.classList.add('btn-loading');
          
          // Reset audio player
          this.elements.audioPlayer.pause();
          
          // Test the stream URL first
          const response = await fetch(url, { method: 'HEAD', mode: 'no-cors' }).catch(() => null);
          
          // Set the source
          this.elements.audioPlayer.src = url;
          this.elements.audioPlayer.crossOrigin = 'anonymous';
          
          // Load and play
          await this.elements.audioPlayer.load();
          
          // Use promise with timeout
          await new Promise((resolve, reject) => {
            const timeout = setTimeout(() => {
              reject(new Error('Connection timeout (10s)'));
            }, 10000);
            
            const onCanPlay = () => {
              clearTimeout(timeout);
              resolve();
            };
            
            const onError = (e) => {
              clearTimeout(timeout);
              reject(new Error('Stream error - check URL and CORS'));
            };
            
            this.elements.audioPlayer.addEventListener('canplay', onCanPlay, { once: true });
            this.elements.audioPlayer.addEventListener('error', onError, { once: true });
          });
          
          await this.elements.audioPlayer.play();
          
          // Setup audio context for VU meter
          if (!this.audioContext) {
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
          }
          
          // Setup meter analyser for VU meter
          if (!this.meterAnalyser) {
            this.meterAnalyser = this.audioContext.createAnalyser();
            this.meterAnalyser.fftSize = 256;
            this.meterDataArray = new Uint8Array(this.meterAnalyser.frequencyBinCount);
          }
          
          if (this.source) {
            this.source.disconnect();
          }
          
          this.source = this.audioContext.createMediaElementSource(this.elements.audioPlayer);
          this.source.connect(this.meterAnalyser);
          this.meterAnalyser.connect(this.audioContext.destination);
          
          this.startVUMeter();
          this.showLiveIndicator();
          
          this.elements.audioStatus.style.background = '#10b981';
          this.elements.audioStatusTextFooter.textContent = 'CONNECTED';
          this.elements.loadStream.classList.remove('btn-loading');
          
          this.updateUI();
          this.showMessage('Stream loaded successfully!', 'success');
        } catch (error) {
          console.error('Error loading stream:', error);
          this.elements.audioStatus.style.background = '#ef4444';
          this.elements.audioStatusTextFooter.textContent = 'ERROR';
          this.elements.loadStream.classList.remove('btn-loading');
          this.showMessage(`Error: ${error.message}`, 'error');
        }
      }

      async startRecording() {
        if (!this.elements.audioPlayer.src || this.elements.audioPlayer.src === '') {
          this.showMessage('No audio stream loaded', 'error');
          return;
        }

        try {
          if (!this.audioContext) {
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
          }

          // Create a MediaStream from the audio element
          let stream;
          
          if (this.elements.audioPlayer.captureStream) {
            stream = this.elements.audioPlayer.captureStream();
          } else {
            // Fallback: try to record from microphone while playing audio
            const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            stream = audioStream;
          }
          
          if (!stream) {
            throw new Error('Could not create recording stream');
          }

          this.recordedChunks = [];
          
          // Try different mime types
          const mimeTypes = [
            'audio/webm;codecs=opus',
            'audio/webm',
            'audio/mp4',
            'audio/ogg;codecs=opus'
          ];
          
          let supportedType = null;
          for (const mimeType of mimeTypes) {
            if (MediaRecorder.isTypeSupported(mimeType)) {
              supportedType = mimeType;
              break;
            }
          }
          
          if (!supportedType) {
            throw new Error('No supported recording format found');
          }
          
          this.mediaRecorder = new MediaRecorder(stream, {
            mimeType: supportedType
          });
          
          this.mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
              this.recordedChunks.push(event.data);
            }
          };
          
          this.mediaRecorder.onstop = async () => {
            try {
              const blob = new Blob(this.recordedChunks, { type: supportedType });
              
              // Create download link
              const url = URL.createObjectURL(blob);
              
              // Create audio element for playback
              const audio = new Audio(url);
              await new Promise((resolve) => {
                audio.onloadedmetadata = resolve;
              });
              
              this.audioBuffer = {
                blob: blob,
                url: url,
                duration: audio.duration,
                audioElement: audio
              };
              
              this.updateUI();
              this.showMessage('Recording completed! Audio is ready for playback.', 'success');
              
              // Show modal to save the clip
              this.showModal();
              
            } catch (error) {
              console.error('Error processing recording:', error);
              this.showMessage('Error processing recording', 'error');
            }
          };
          
          this.mediaRecorder.onerror = (event) => {
            console.error('MediaRecorder error:', event);
            this.showMessage('Recording error occurred', 'error');
          };
          
          this.mediaRecorder.start(1000); // Collect data every second
          this.isRecording = true;
          this.recordingStartTime = Date.now();
          
          this.elements.recStatus.classList.remove('hidden');
          this.updateUI();
          
          this.showMessage('Recording started', 'success');
        } catch (error) {
          console.error('Error starting recording:', error);
          this.showMessage(`Recording error: ${error.message}`, 'error');
        }
      }

      stopRecording() {
        if (this.mediaRecorder && this.isRecording) {
          try {
            this.mediaRecorder.stop();
            this.isRecording = false;
            
            // Stop all tracks
            if (this.mediaRecorder.stream) {
              this.mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            
            this.elements.recStatus.classList.add('hidden');
            this.updateUI();
            
          } catch (error) {
            console.error('Error stopping recording:', error);
          }
        }
      }

      playSelection() {
        if (!this.audioBuffer || !this.audioBuffer.audioElement) return;
        
        try {
          const audio = this.audioBuffer.audioElement;
          
          if (audio.paused) {
            audio.play();
            this.showMessage('Playing recorded audio...', 'info');
          } else {
            audio.pause();
            this.showMessage('Playback paused', 'info');
          }
          
        } catch (error) {
          console.error('Error playing selection:', error);
          this.showMessage('Error playing audio', 'error');
        }
      }

      updatePlayerTime() {
        try {
          const current = this.elements.audioPlayer.currentTime;
          const duration = this.elements.audioPlayer.duration || 0;
          
          if (!isNaN(current) && !isNaN(duration)) {
            this.elements.currentTime.textContent = this.formatTime(current, false, true);
            this.elements.totalTime.textContent = this.formatTime(duration, false, true);
            this.updateWaveformTime(current);
          }
          
          this.updateProgressBar();
        } catch (error) {
          console.error('Error updating player time:', error);
        }
      }

      onAudioLoaded() {
        this.updateUI();
        this.drawWaveform();
      }

      onAudioPlay() {
        this.isPlaying = true;
        this.elements.audioPlayer.style.boxShadow = '0 0 30px rgba(59, 130, 246, 0.5)';
        this.startVUMeter();
        this.showLiveIndicator();
      }

      onAudioPause() {
        this.isPlaying = false;
        this.elements.audioPlayer.style.boxShadow = 'none';
        this.stopVUMeter();
        this.hideLiveIndicator();
        this.drawWaveform();
      }

      // Utility Functions
      formatTime(seconds, inputFormat = false, shortFormat = false) {
        if (isNaN(seconds) || !isFinite(seconds)) return '00:00';
        
        const hrs = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        
        if (shortFormat) {
          if (hrs > 0) {
            return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
          }
          return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        if (inputFormat) {
          return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        if (hrs > 0) {
          return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      }

      parseTime(timeString) {
        const parts = timeString.split(':').map(part => parseInt(part) || 0);
        
        if (parts.length === 3) {
          return parts[0] * 3600 + parts[1] * 60 + parts[2];
        } else if (parts.length === 2) {
          return parts[0] * 60 + parts[1];
        }
        return parts[0];
      }

      showMessage(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 15px 25px;
          background: ${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#3b82f6'};
          color: white;
          border-radius: 10px;
          font-weight: var(--font-weight-semibold);
          z-index: 1000;
          animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          box-shadow: var(--glass-shadow);
          display: flex;
          align-items: center;
          gap: 10px;
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.1);
          max-width: 400px;
        `;
        
        const icon = type === 'error' ? 'fas fa-exclamation-circle' :
                    type === 'success' ? 'fas fa-check-circle' :
                    'fas fa-info-circle';
        
        notification.innerHTML = `<i class="${icon}"></i> ${message}`;
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.style.animation = 'slideOut 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      saveStation() {
        const url = this.elements.streamUrl.value.trim();
        const name = this.elements.radioName.value.trim() || `Station ${this.savedStations.length + 1}`;
        
        if (!url) {
          this.showMessage('Please enter a stream URL', 'error');
          return;
        }
        
        const existingIndex = this.savedStations.findIndex(station => station.url === url);
        if (existingIndex !== -1) {
          this.savedStations[existingIndex].name = name;
        } else {
          this.savedStations.push({ name, url });
        }
        
        localStorage.setItem('savedStations', JSON.stringify(this.savedStations));
        this.updateStationsList();
        this.showMessage('Station saved successfully!', 'success');
      }

      updateStationsList() {
        const container = this.elements.stationsList;
        container.innerHTML = '';
        
        this.savedStations.forEach((station, index) => {
          const stationEl = document.createElement('div');
          stationEl.className = 'station-item slide-in';
          stationEl.innerHTML = `
            <div class="station-info">
              <div class="station-name">${station.name}</div>
              <div class="station-url">${station.url}</div>
            </div>
            <div class="station-actions">
              <button class="icon-btn load-station-btn" data-index="${index}" data-tooltip="Carica stazione">
                <i class="fas fa-play"></i>
              </button>
              <button class="icon-btn delete-station-btn" data-index="${index}" data-tooltip="Elimina stazione">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `;
          
          container.appendChild(stationEl);
          
          const loadBtn = stationEl.querySelector('.load-station-btn');
          const deleteBtn = stationEl.querySelector('.delete-station-btn');
          
          loadBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.loadStation(index);
          });
          
          deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.deleteStation(index);
          });
          
          stationEl.addEventListener('click', () => {
            this.loadStation(index);
          });
        });
        
        this.elements.stationsCount.textContent = `(${this.savedStations.length})`;
      }

      loadStation(index) {
        const station = this.savedStations[index];
        if (!station) return;
        
        this.elements.streamUrl.value = station.url;
        this.elements.radioName.value = station.name;
        
        document.querySelectorAll('.station-item').forEach((item, i) => {
          item.classList.toggle('active', i === index);
        });
        
        this.showMessage(`Loading ${station.name}...`, 'info');
        
        setTimeout(() => {
          this.loadAudioStream();
        }, 500);
      }

      deleteStation(index) {
        const station = this.savedStations[index];
        if (!station) return;
        
        if (confirm(`Delete station "${station.name}"?`)) {
          this.savedStations.splice(index, 1);
          localStorage.setItem('savedStations', JSON.stringify(this.savedStations));
          this.updateStationsList();
          this.showMessage('Station deleted', 'success');
        }
      }

      setSelectionPoint(type) {
        const currentTime = this.elements.audioPlayer.currentTime;
        
        if (type === 'start') {
          this.elements.startTime.value = this.formatTime(currentTime, true);
        } else {
          this.elements.endTime.value = this.formatTime(currentTime, true);
        }
        
        this.updateSelectionDuration();
      }

      updateSelectionDuration() {
        const start = this.parseTime(this.elements.startTime.value);
        const end = this.parseTime(this.elements.endTime.value);
        
        if (start >= 0 && end > start) {
          const duration = end - start;
          this.elements.selectionDuration.textContent = `Duration: ${this.formatTime(duration)}`;
        }
      }

      async trimAudio() {
        if (!this.audioBuffer) {
          this.showMessage('No audio to trim', 'error');
          return;
        }
        
        const start = this.parseTime(this.elements.startTime.value);
        const end = this.parseTime(this.elements.endTime.value);
        
        if (start < 0 || end <= start) {
          this.showMessage('Invalid time range', 'error');
          return;
        }
        
        this.showMessage('Trimming audio...', 'info');
        this.elements.trimAudio.classList.add('btn-loading');
        
        setTimeout(() => {
          this.elements.trimAudio.classList.remove('btn-loading');
          this.showMessage('Audio trimmed successfully!', 'success');
          this.elements.exportClip.disabled = false;
        }, 1000);
      }

      exportClip() {
        if (!this.audioBuffer || !this.audioBuffer.blob) {
          this.showMessage('No audio to export', 'error');
          return;
        }
        
        const name = this.elements.exportName.value.trim() || 'clip';
        const format = this.elements.exportFormat.value;
        
        // Create download link for the recorded audio
        const url = this.audioBuffer.url;
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `${name}.${format}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        this.saveToClipsLibrary(`${name}.${format}`);
        this.showMessage('Clip exported successfully!', 'success');
      }

      saveToClipsLibrary(filename) {
        const clip = {
          id: Date.now(),
          name: filename,
          timestamp: new Date().toLocaleTimeString(),
          format: this.elements.exportFormat.value,
          size: this.formatFileSize(this.audioBuffer.blob.size),
          url: this.audioBuffer.url
        };
        
        this.savedClips.unshift(clip);
        localStorage.setItem('savedClips', JSON.stringify(this.savedClips));
        this.updateClipsList();
      }

      formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }

      updateClipsList() {
        const container = this.elements.clipsList;
        container.innerHTML = '';
        
        this.savedClips.forEach((clip, index) => {
          const clipEl = document.createElement('div');
          clipEl.className = 'clip-item slide-in';
          clipEl.innerHTML = `
            <div class="clip-header">
              <div class="clip-title">${clip.name}</div>
              <div class="clip-time">${clip.timestamp}</div>
            </div>
            <div class="clip-meta">
              <span>Format: ${clip.format.toUpperCase()}</span>
              <span>Size: ${clip.size}</span>
            </div>
            <div class="clip-actions">
              <button class="btn btn-secondary btn-small play-clip-btn" data-index="${index}" data-tooltip="Riproduci clip">
                <i class="fas fa-play"></i> PLAY
              </button>
              <button class="btn btn-secondary btn-small export-clip-btn" data-index="${index}" data-tooltip="Esporta clip">
                <i class="fas fa-download"></i> EXPORT
              </button>
              <button class="btn btn-danger btn-small delete-clip-btn" data-index="${index}" data-tooltip="Elimina clip">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `;
          
          container.appendChild(clipEl);
          
          clipEl.querySelector('.play-clip-btn').addEventListener('click', () => {
            this.playClip(clip);
          });
          
          clipEl.querySelector('.export-clip-btn').addEventListener('click', () => {
            this.exportClipFromLibrary(clip);
          });
          
          clipEl.querySelector('.delete-clip-btn').addEventListener('click', () => {
            this.deleteClip(index);
          });
        });
        
        this.elements.clipsCount.textContent = `(${this.savedClips.length})`;
      }

      playClip(clip) {
        if (!clip.url) {
          this.showMessage('Clip URL not found', 'error');
          return;
        }
        
        const audio = new Audio(clip.url);
        audio.play();
        this.showMessage(`Playing ${clip.name}`, 'info');
      }

      exportClipFromLibrary(clip) {
        if (!clip.url) {
          this.showMessage('Clip URL not found', 'error');
          return;
        }
        
        const a = document.createElement('a');
        a.href = clip.url;
        a.download = clip.name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        this.showMessage(`Exported ${clip.name}`, 'success');
      }

      deleteClip(index) {
        if (confirm('Delete this clip?')) {
          // Revoke object URL to free memory
          if (this.savedClips[index].url) {
            URL.revokeObjectURL(this.savedClips[index].url);
          }
          
          this.savedClips.splice(index, 1);
          localStorage.setItem('savedClips', JSON.stringify(this.savedClips));
          this.updateClipsList();
          this.showMessage('Clip deleted', 'success');
        }
      }

      showModal() {
        this.elements.nameModal.classList.add('active');
        this.elements.clipNameInput.focus();
        this.elements.clipNameInput.value = `clip_${new Date().toISOString().slice(11, 19).replace(/:/g, '')}`;
      }

      hideModal() {
        this.elements.nameModal.classList.remove('active');
      }

      saveCurrentClip() {
        const name = this.elements.clipNameInput.value.trim();
        if (!name) {
          this.showMessage('Please enter a clip name', 'error');
          return;
        }
        
        const format = 'webm'; // Default format for recorded clips
        this.saveToClipsLibrary(`${name}.${format}`);
        this.hideModal();
        this.showMessage('Clip saved to library!', 'success');
      }

      saveStations() {
        localStorage.setItem('savedStations', JSON.stringify(this.savedStations));
      }
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', () => {
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
        @keyframes shimmer {
          0% { transform: translateX(-100%); }
          100% { transform: translateX(100%); }
        }
      `;
      document.head.appendChild(style);
      
      window.audioRecorder = new AudioRecorder();
    });
  </script>
</body>
</html>